name: deploy-book

# Only run this when the branch listed below changes
on:
  push:
    branches:
    - main

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# This job installs dependencies, build the book, and pushes it to `gh-pages`
jobs:
  deploy-book:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install dependencies
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        pip install -r book-requirements-Linux-macOS.txt
    # Build the book
    - name: Build the book
      run: |
        jupyter-book build .
    
    # Commit and push the built HTML to main branch
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push built site
      run: |
        # Move built HTML to root level
        cp -r _build/html/* .
        # Remove _build directory from git
        git rm -r _build --cached || true
        # Add all changes
        git add -A
        git commit -m "Update site build from GitHub Actions" || true
        git push
